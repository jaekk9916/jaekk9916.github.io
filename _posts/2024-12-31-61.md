---
title: Leveraging Multiprocessing in mediasoup
date: 2024-12-31 17:49:58 +0500
categories: [WebRTC]
tags: [WebRTC, websocket, mediasoup]
---

# 1. Worker pool management

```javascript
// Managing multiple workers through the mediasoup Workers array
const mediasoupWorkers = [];
let nextMediasoupWorkerIdx = 0;
```
<br>

# 2. Create the set number of workers
```javascript
const { numWorkers } = config.mediasoup;
for (let i = 0; i < numWorkers; ++i) {
    const worker = await mediasoup.createWorker({...});
    mediasoupWorkers.push(worker);
}
```
<br>

# 3. Assigning Workers in Round-Robin
```javascript
function getMediasoupWorker() {
    const worker = mediasoupWorkers[nextMediasoupWorkerIdx];
    
    if (++nextMediasoupWorkerIdx === mediasoupWorkers.length)
        nextMediasoupWorkerIdx = 0;
        
    return worker;
}
```
<br>
> What is a Round-Robin?
> Round robin is a scheduling algorithm that alternately allocates resources in a sequential order
> > Advantages
> > Simple and intuitive implementation
> > Provide fair opportunities for all workers
> > Evenly distribute CPU load
> > Prevents work from being pushed to certain workers <br>

> > disadvantages
> > Doesn't take into account a worker's current load status
> > Difficult to reflect the prioritization of tasks
> > Assumes all workers have the same processing power


# 4. Assign Workers to each Room
```javascript
async function getOrCreateRoom({ roomId, consumerReplicas }) {
    if (!room) {
        const mediasoupWorker = getMediasoupWorker();
        room = await Room.create({ mediasoupWorker, roomId, consumerReplicas });
    }
}
```

## Key features
1. Parallelism: Each Worker runs on a separate CPU process, enabling parallel processing.<br>
2. Load balancing: Evenly distributes system load across multiple CPUs by allocating Workers in a round-robin fashion.<br>
3. Monitoring: Periodic monitoring of each worker's resource usage.
   ```javascript
       setInterval(async () => {
        const usage = await worker.getResourceUsage();
        logger.info('mediasoup Worker resource usage [pid:%d]: %o', worker.pid, usage);
    }, 120000);
    ```
4. Failover: Designed to restart the entire process if a worker is terminated.
   ```javascript
       worker.on('died', () => {
        logger.error('mediasoup Worker died, exiting in 2 seconds... [pid:%d]', worker.pid);
        setTimeout(() => process.exit(1), 2000);
    });
   ```
